name: Terraform Infra Setup 

on:
  push:
  workflow_dispatch:
env:
  AWS_REGION: ap-south-1
permissions:
  id-token: write
  contents: write

jobs:
  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: sit

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          aws-region: ap-south-1


      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.5

      - name: Install Terraform Lint
        run: |
          wget https://github.com/terraform-linters/tflint/releases/download/v0.50.2/tflint_linux_amd64.zip
          unzip tflint_linux_amd64.zip
          sudo mv tflint /usr/local/bin/
          tflint --version

      - name: Install Checkov 
        run: |
          python -m pip install --upgrade pip
          pip install checkov

      - name: Run Checkov Static Analysis
        run: |
          checkov -d . --skip-path .github/* --skip-path k8s/*   --soft-fail

      - name: Generate terraform docs
        uses: terraform-docs/gh-actions@main
        with:          
          working-dir: ./
          output-file: README.md
          output-method: inject
          git-push: "true"

      - name: Install Terragrunt v0.45.4
        run: |
          sudo wget -q -O /bin/terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/v0.45.4/terragrunt_linux_amd64"
          sudo chmod +x /bin/terragrunt

      - name: Terragrunt Validate
        run: terragrunt validate

      - name: Terragrunt Format
        run: terragrunt fmt

      - name: Run Terragrunt Lint
        run: tflint --init

      # Run terragrunt Plan in all folders
      - name: Terragrunt Plan
        run: terragrunt run-all plan --terragrunt-non-interactive

      # # Run terragrunt Apply in all folders
      # - name: Terragrunt apply
      #   run: terragrunt run-all apply --terragrunt-non-interactive

      # Run terragrunt destroy in all folders
      - name: Terragrunt destroy
        run: terragrunt run-all destroy --terragrunt-non-interactive








